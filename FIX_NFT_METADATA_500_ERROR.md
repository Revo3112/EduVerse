# NFT Metadata 500 Error - Root Cause & Fix

## Problem Summary

NFTs minted via CertificateManager contract show no image in MetaMask and other wallets. Instead, they only display:
- Contract address
- Token ID  
- Token standard (ERC1155)
- Disclaimer message

## Root Cause

The `/api/nft/certificate/[tokenId]/route.ts` API endpoint was using an **outdated Certificate struct format** that doesn't match the current `CertificateManager.sol` contract.

### Error from Vercel Logs
```
Error [InvalidParameterError]: Invalid ABI parameter.
Details: tuple(uint256 tokenId, string recipientName, string institutionName, address recipient, bool isValid, bool isMinted, string baseRoute, string qrData, uint256 mintedAt, uint256 lastUpdated, uint256 totalCourses, bytes32 paymentReceiptHash)
```

### Struct Mismatch

**OLD struct (API was using):**
```solidity
tuple(
  uint256 tokenId,
  string recipientName,
  string institutionName,    // ❌ WRONG
  address recipient,          // ❌ WRONG
  bool isValid,
  bool isMinted,              // ❌ REMOVED
  string baseRoute,
  string qrData,              // ❌ REMOVED
  uint256 mintedAt,           // ❌ WRONG NAME
  uint256 lastUpdated,
  uint256 totalCourses,       // ❌ WRONG NAME
  bytes32 paymentReceiptHash
)
```

**ACTUAL struct (CertificateManager.sol):**
```solidity
struct Certificate {
  uint256 tokenId;
  string platformName;             // ✅ NOT "institutionName"
  string recipientName;
  address recipientAddress;        // ✅ NOT "recipient"
  bool lifetimeFlag;               // ✅ NEW FIELD
  bool isValid;
  string ipfsCID;                  // ✅ NEW FIELD
  string baseRoute;
  uint256 issuedAt;                // ✅ NOT "mintedAt"
  uint256 lastUpdated;
  uint256 totalCoursesCompleted;   // ✅ NOT "totalCourses"
  bytes32 paymentReceiptHash;
  // completedCourses[] fetched separately
}
```

## Solution Applied

Updated both API routes to match the current contract:

### Files Fixed:
1. ✅ `eduweb/src/app/api/nft/certificate/[tokenId]/route.ts`
2. ✅ `eduweb/src/app/api/nft/certificate/[tokenId]/image/route.tsx`

### Changes Made:
- Updated `CertificateData` interface to match actual struct
- Changed `getCertificate()` function ABI signature
- Updated field mappings:
  - `institutionName` → `platformName`
  - `recipient` → `recipientAddress`
  - `mintedAt` → `issuedAt`
  - `totalCourses` → `totalCoursesCompleted`
  - Added `lifetimeFlag` and `ipfsCID` fields
  - Removed `isMinted` and `qrData` (no longer in struct)

## How NFT Metadata Works

### Architecture:
```
MetaMask/Wallet
    ↓ calls uri(tokenId)
CertificateManager.sol
    ↓ returns defaultMetadataBaseURI + "/" + tokenId
    ↓ = https://edu-verse-blond.vercel.app/api/nft/certificate/1
API Route (route.ts)
    ↓ reads contract with correct struct
    ↓ generates ERC-1155 compatible metadata JSON
    ↓ includes image URL pointing to /image route
MetaMask/Wallet displays image
```

### Key Points:
1. Contract's `uri(tokenId)` returns API endpoint URL
2. `defaultMetadataBaseURI` is set during deployment: `https://edu-verse-blond.vercel.app/api/nft/certificate`
3. API dynamically generates metadata from on-chain data
4. Image generated by `/image` route or served from IPFS CID

## Deployment Instructions

### 1. Verify Environment Variables
```bash
cd eduweb
grep "NEXT_PUBLIC_APP_URL" .env.local
# Should show: NEXT_PUBLIC_APP_URL=https://edu-verse-blond.vercel.app
```

### 2. Deploy Fixed API Routes to Vercel
```bash
cd eduweb
git add src/app/api/nft/certificate/
git commit -m "Fix: Update NFT metadata API to match CertificateManager.sol struct"
git push origin main
```

Vercel will auto-deploy. Wait ~2-3 minutes for deployment.

### 3. Verify Fix

**A. Test API Endpoint Directly:**
```bash
curl https://edu-verse-blond.vercel.app/api/nft/certificate/1
```

Should return JSON like:
```json
{
  "name": "EduVerse Academy Certificate - Revo Rahmat",
  "description": "This certificate verifies that Revo Rahmat has successfully completed 1 course from EduVerse Academy...",
  "image": "https://edu-verse-blond.vercel.app/api/nft/certificate/1/image",
  "external_url": "https://edu-verse-blond.vercel.app/certificates?verify=1",
  "attributes": [...]
}
```

**B. Test Image Route:**
```bash
curl -I https://edu-verse-blond.vercel.app/api/nft/certificate/1/image
```

Should return `200 OK` with `Content-Type: image/png`

**C. Check MetaMask:**
1. Open MetaMask
2. Go to NFTs tab
3. Find certificate NFT (token ID 1)
4. Wait 30-60 seconds for MetaMask to refresh metadata
5. **If still not showing:** Click NFT → Refresh metadata (three dots menu)

### 4. Force Metadata Refresh (if needed)

Some wallets cache metadata. To force refresh:

**MetaMask:**
- Click NFT → ⋮ (three dots) → "Refresh metadata"

**OpenSea:**
```bash
# Visit:
https://testnets.opensea.io/assets/manta-pacific-testnet/0x335BD88512Ce9Eff0009f05261ec47679427805d/1
# Click "Refresh metadata" button
```

**Blockscout:**
- Metadata auto-refreshes every ~10 minutes
- Or visit: `https://pacific-explorer.testnet.manta.network/token/0x335BD88512Ce9Eff0009f05261ec47679427805d/instance/1`

## Verification Checklist

- [ ] API endpoint returns 200 (not 500)
- [ ] JSON includes `name`, `description`, `image`, `attributes`
- [ ] Image URL returns valid PNG
- [ ] MetaMask shows certificate image
- [ ] Certificate displays on blockchain explorer
- [ ] New certificates minted after fix work correctly

## Additional Notes

### Contract Configuration
The contract's `defaultMetadataBaseURI` should already be set via deployment script:
```javascript
await certificateManager.updateDefaultMetadataBaseURI(
  "https://edu-verse-blond.vercel.app/api/nft/certificate"
);
```

### If Metadata URI Is Not Set
```bash
# Check current value
cast call 0x335BD88512Ce9Eff0009f05261ec47679427805d \
  "defaultMetadataBaseURI()(string)" \
  --rpc-url https://pacific-rpc.testnet.manta.network

# Set if needed (requires contract owner/admin)
cast send 0x335BD88512Ce9Eff0009f05261ec47679427805d \
  "updateDefaultMetadataBaseURI(string)" \
  "https://edu-verse-blond.vercel.app/api/nft/certificate" \
  --rpc-url https://pacific-rpc.testnet.manta.network \
  --private-key $PRIVATE_KEY
```

## Future Prevention

To avoid this issue in the future:

1. **Always sync API routes with contract changes**
2. **Add automated tests** that verify struct compatibility
3. **Use TypeScript code generation** from contract ABIs
4. **Add CI/CD checks** that validate API responses against contract

## Testing New Certificate Mints

After fix is deployed, test by minting a new certificate:

```bash
# Complete a course and mint certificate
# Then check:
curl https://edu-verse-blond.vercel.app/api/nft/certificate/2

# Should work for new token IDs
```

---

**Status:** ✅ FIXED - Ready for deployment
**Files Changed:** 2 API routes
**Breaking Changes:** None (backward compatible)
**Testing Required:** Manual verification in MetaMask + API endpoint tests