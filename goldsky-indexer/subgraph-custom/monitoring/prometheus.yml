# ============================================================================
# EduVerse Subgraph Prometheus Configuration v1.1.0
# ============================================================================

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  scrape_timeout: 10s

# Alert manager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - 'alertmanager:9093'

# Rule files to load
rule_files:
  - "rules/subgraph_rules.yml"

scrape_configs:
  # Goldsky Subgraph Metrics
  - job_name: 'goldsky-subgraph'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['goldsky-indexer:8040']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'goldsky-subgraph'

  # The Graph Node Metrics
  - job_name: 'graph-node'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['graph-node:8040']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'graph-node'

  # Redis Cache Metrics
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-cache:9121']
    metrics_path: '/metrics'

  # API Response Time Metrics
  - job_name: 'api-metrics'
    metrics_path: '/metrics'
    static_configs:
      - targets: ['api:3000']

  # Node Exporter (System Metrics)
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']

# ============================================================================
# Recording Rules - Pre-calculate expensive queries
# ============================================================================

rules:
  groups:
    - name: subgraph_performance
      interval: 1m
      rules:
        # Query response time
        - record: subgraph:query_time:avg_5m
          expr: rate(subgraph_query_execution_time_sum[5m]) / rate(subgraph_query_execution_time_count[5m])

        # Cache hit ratio
        - record: subgraph:cache_hit_ratio:5m
          expr: rate(subgraph_cache_hits_total[5m]) / (rate(subgraph_cache_hits_total[5m]) + rate(subgraph_cache_misses_total[5m]))

        # Indexing speed
        - record: subgraph:blocks_per_second:5m
          expr: rate(subgraph_blocks_processed_total[5m])

# ============================================================================
# Alert Rules - Define conditions that should trigger alerts
# ============================================================================

alerts:
  groups:
    - name: subgraph_alerts
      rules:
        # High query latency
        - alert: SubgraphHighQueryLatency
          expr: subgraph:query_time:avg_5m > 1
          for: 5m
          labels:
            severity: warning
          annotations:
            summary: "High query latency"
            description: "Query latency is above 1 second for 5 minutes"

        # Low cache hit ratio
        - alert: SubgraphLowCacheHitRatio
          expr: subgraph:cache_hit_ratio:5m < 0.8
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "Low cache hit ratio"
            description: "Cache hit ratio is below 80% for 15 minutes"

        # Indexing lag
        - alert: SubgraphIndexingLag
          expr: ethereum_chain_head_number - ethereum_chain_sync_head_number > 100
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "Subgraph is lagging behind"
            description: "Subgraph is more than 100 blocks behind chain head"

        # High error rate
        - alert: SubgraphHighErrorRate
          expr: rate(subgraph_query_execution_error_total[5m]) > 0.01
          for: 5m
          labels:
            severity: critical
          annotations:
            summary: "High query error rate"
            description: "Query error rate is above 1% for 5 minutes"

        # Memory usage
        - alert: SubgraphHighMemoryUsage
          expr: process_resident_memory_bytes / process_virtual_memory_bytes > 0.8
          for: 15m
          labels:
            severity: warning
          annotations:
            summary: "High memory usage"
            description: "Memory usage is above 80% for 15 minutes"

# ============================================================================
# Storage Configuration
# ============================================================================

storage:
  tsdb:
    # How long to retain metrics
    retention_time: 15d
    # Maximum number of bytes that can be stored
    max_bytes: 21474836480  # 20GB

# ============================================================================
# Web Configuration - Dashboard & API settings
# ============================================================================

web:
  enable_admin_api: true
  enable_lifecycle: true
  external_url: http://localhost:9090
  route_prefix: /

# ============================================================================
# Remote Write Configuration - For long-term storage
# ============================================================================

remote_write:
  - url: "http://victoria-metrics:8428/api/v1/write"
    remote_timeout: 30s
    queue_config:
      capacity: 500000
      max_shards: 1000
      max_samples_per_send: 100
